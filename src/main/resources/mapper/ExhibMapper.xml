<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart42.khtour.mapper.ExhibMapper">
	<resultMap type="Exhib" 				id="exhibResultMap">
		<id column="exhib_code" 			property="exhibCode" />			<!-- 전시회 코드 -->
		<result column="mus_code" 			property="musCode" />			<!-- 문화재 및 박물관 코드 -->
		<result column="exhib_cate" 		property="exhibCate" />			<!-- 전시회카테고리코드 -->
		<result column="exhib_cate_name" 	property="exhibCateName" />		<!-- 전시회카테고리 -->
		<result column="exhib_name" 		property="exhibName" />			<!-- 전시회이름 -->
		<result column="exhib_start" 		property="exhibStart" />		<!-- 전시회시작일 -->
		<result column="exhib_end"	 		property="exhibEnd" />			<!-- 전시회종료일 -->
		<result column="exhib_con"			property="exhibCon" />			<!-- 전시회내용 -->
		<result column="exhib_current" 		property="exhibCurrent" />		<!-- 전시회현황 -->
		<result column="exhib_page" 		property="exhibPage" />			<!-- 전시회홈페이지-->
		
		<result column="file_path" 				property="exhibImagePath"/>
	</resultMap>
	<select id="fileInfoByFileIdx" resultType="FileDto">
      SELECT
          f.file_idx            AS fileIdx
         ,f.file_new_name      	AS fileNewName
         ,f.file_original_name	AS fileOriginalName
         ,f.file_path         	AS filePath
         ,f.file_size         	AS fileSize
      FROM
         tb_exhib AS h
         LEFT JOIN 
         tb_file_control AS fc
         ON 
         h.exhib_code = fc.reference_code
         LEFT JOIN 
         tb_file AS f   
         ON 
         f.file_idx = fc.file_idx
      WHERE
         h.exhib_code = #{exhibCode};
   </select>
	<!-- 전시회 등록 SQL -->
	<insert id="addExhib" parameterType="Exhib">
		<selectKey resultType="string" keyProperty="exhibCode" order="BEFORE">
        SELECT sf_new_exhib_code() as exhibCode
        </selectKey>
		INSERT INTO tb_exhib
		(exhib_code
		,mus_code
		,exhib_cate
		,exhib_cate_name
		,exhib_name
		,exhib_start
		,exhib_end
		,exhib_con
		,exhib_current
		,exhib_page
		) VALUES (
		 #{exhibCode}
		,#{musCode}
		,#{exhibCate}
		,#{exhibCateName}
		,#{exhibName}
		,#{exhibStart}
		,#{exhibEnd}
		,#{exhibCon}
		,#{exhibCurrent}
		,#{exhibPage}
		);
	</insert>

	<!-- 전시회 명 중복 체크 -->
   <select id="isNameCheck" parameterType="String" resultType="boolean">
      SELECT
         IF(COUNT(1) = 1, 0, 1)
      FROM 
         tb_exhib AS e
      WHERE 
         e.exhib_name = #{exhibName};
   </select>

	<!-- 코드에 따른 전시회 조회 SQL -->
	<select id="getExhibByCode" parameterType="String" resultMap="exhibResultMap">
		SELECT
		 s.exhib_code
		,s.mus_code
		,s.exhib_cate
		,s.exhib_cate_name
		,s.exhib_name
		,s.exhib_start
		,s.exhib_end
		,s.exhib_con
		,s.exhib_current
		,s.exhib_page
		FROM
			tb_exhib AS s
		WHERE
			exhib_code = #{exhibCode};
	
	</select>
	
	<!-- 전시회 목록 조회 SQL -->
	<select id="getExhibList" resultMap="exhibResultMap">
		SELECT
		 s.exhib_code
		,s.mus_code
		,s.exhib_cate
		,s.exhib_cate_name
		,s.exhib_name
		,s.exhib_start
		,s.exhib_end
		,s.exhib_con
		,s.exhib_current
		,s.exhib_page
		FROM
		tb_exhib AS s
		LEFT JOIN 
         tb_file_control AS fc
         ON 
         s.exhib_code = fc.reference_code
         LEFT JOIN 
         tb_file AS f
         ON 
         fc.file_idx = f.file_idx
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="searchKey != null and searchKey != '' and searchValue != ''">
		 		AND ${searchKey} LIKE CONCAT('%', #{searchValue}, '%')
		 	</if>
		</trim>
		ORDER BY s.exhib_code;
	</select>
	
	
	<!-- 유저 전시회 조회 -->
	<select id="ingExhib" resultMap="exhibResultMap">
		SELECT
			s.exhib_name
			,s.exhib_cate
			,s.exhib_start
			,s.exhib_end
			,s.exhib_con
			,f.file_path
		FROM
			tb_exhib AS s
			INNER JOIN
			tb_file_control AS fc
			ON
			s.exhib_code = fc.reference_code
         	LEFT JOIN 
         	tb_file AS f
         	ON 
         	fc.file_idx = f.file_idx
		WHERE
			s.exhib_current =  '전시중';
	</select>
	<select id="expectedExhib" resultMap="exhibResultMap">
		SELECT
			s.exhib_name
			,s.exhib_cate
			,s.exhib_start
			,s.exhib_end
			,s.exhib_con
			,f.file_path
		FROM
			tb_exhib AS s
			INNER JOIN
			tb_file_control AS fc
			ON
			s.exhib_code = fc.reference_code
         	LEFT JOIN 
         	tb_file AS f
         	ON 
         	fc.file_idx = f.file_idx
		WHERE
			s.exhib_current = '전시예정';
	</select>
	<select id="endExhib" resultMap="exhibResultMap">
		SELECT
			s.exhib_name
			,s.exhib_cate
			,s.exhib_start
			,s.exhib_end
			,s.exhib_con
			,f.file_path
		FROM
			tb_exhib AS s
			INNER JOIN
			tb_file_control AS fc
			ON
			s.exhib_code = fc.reference_code
         	LEFT JOIN 
         	tb_file AS f
         	ON 
         	fc.file_idx = f.file_idx
		WHERE
			s.exhib_current =  '전시완료';
	</select>
	<!-- 전시회 수정 SQL -->
	<update id="modifyExhib" parameterType="Exhib">
		UPDATE tb_exhib
		<trim prefix="SET" suffixOverrides=",">
			<if test="musCode != null and musCode != ''">
				mus_code = #{musCode},
			</if>		
			<if test="exhibCate != null and exhibCate != ''">
				exhib_cate = #{exhibCate},
			</if>		
			<if test="exhibCateName != null and exhibCateName != ''">
				exhib_cate_name = #{exhibCateName},
			</if>		
			<if test="exhibName != null and exhibName != ''">
				exhib_name = #{exhibName},
			</if>		
			<if test="exhibStart != null and exhibStart != ''">
				exhib_start = #{exhibStart},
			</if>		
			<if test="exhibEnd != null and exhibEnd != ''">
				exhib_end = #{exhibEnd},
			</if>		
			<if test="exhibCon != null and exhibCon != ''">
				exhib_con = #{exhibCon},
			</if>		
			<if test="exhibCurrent != null and exhibCurrent != ''">
				exhib_current = #{exhibCurrent},
			</if>		
			<if test="exhibPage != null and exhibPage != ''">
				exhib_page = #{exhibPage},
			</if>		
		</trim>
		WHERE
			exhib_code = #{exhibCode};
	</update>
	
	<!-- 전시회 정보 삭제 SQL -->
	<delete id="removeExhib" parameterType="String">
		DELETE
		FROM
			tb_exhib
		WHERE
			exhib_code = #{exhibCode};
	</delete>
</mapper>